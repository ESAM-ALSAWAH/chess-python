<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='chessboardjs/css/chessboard-1.0.0.min.css') }}"
      integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU"
      crossorigin="anonymous"
    />

    <title>Document</title>
    <style>
      body {
        display: grid;
        place-items: center;
        min-height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="myBoard" style="width: 700px; margin: auto"></div>
    <script
      src="https://code.jquery.com/jquery-3.7.0.js"
      integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM="
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="{{ url_for('static', filename='chessboardjs/js/chessboard-1.0.0.min.js') }}"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"
      integrity="sha512-xRllwz2gdZciIB+AkEbeq+gVhX8VB8XsfqeFbUh+SzHlN96dEduwtTuVuc2u9EROlmW9+yhRlxjif66ORpsgVA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      $(function () {
        var game = new Chess();
        var board = null;
        var $status = $("#status");
        var $fen = $("#fen");
        var $pgn = $("#pgn");
        var whiteSquareGrey = "#c37d448f";
        var blackSquareGrey = "#cd9a70";
        function removeGreySquares() {
          $("#myBoard .square-55d63").css("background", "");
        }

        function greySquare(square) {
          var $square = $("#myBoard .square-" + square);

          var background = whiteSquareGrey;
          if ($square.hasClass("black-3c85d")) {
            background = blackSquareGrey;
          }

          $square.css("background", background);
        }

        function onMouseoverSquare(square, piece) {
          if (game.turn() !== "w") {
            return false;
          }
          // get list of possible moves for this square
          var moves = game.moves({
            square: square,
            verbose: true,
          });

          // exit if there are no moves available for this square
          if (moves.length === 0) return;

          // highlight the square they moused over
          greySquare(square);

          // highlight the possible squares for this piece
          for (var i = 0; i < moves.length; i++) {
            greySquare(moves[i].to);
          }
        }

        function onMouseoutSquare(square, piece) {
          removeGreySquares();
        }

        function onDragStart(source, piece, position, orientation) {
          // do not pick up pieces if the game is over
          if (game.game_over()) return false;

          // only pick up pieces for the side to move
          if (game.turn() === "w" && piece.search(/^b/) !== -1) {
            return false;
          }
        }

        function onDrop(source, target) {
          // see if the move is legal
          var move = game.move({
            from: source,
            to: target,
            promotion: "q", // NOTE: always promote to a queen for example simplicity
          });
          // illegal move
          if (move === null) return "snapback";
          else {
            $.get(`/move?name=${move.from + move.to}`, function (data) {
              console.log(data);

              // Update the board position with the computer's move
              game.load(data.fen);
              board.position(game.fen());

              // Update the status of the game
            });
            setTimeout(() => {
              updateStatus();
            }, 300);
          }
        }

        // update the board position after the piece snap
        // for castling, en passant, pawn promotion
        function onSnapEnd() {
          // console.log(game.fen());
          board.position(game.fen());
        }

        function updateStatus() {
          var status = "";
          console.log(game.in_checkmate());
          var moveColor = "White";
          if (game.turn() === "b") {
            moveColor = "Black";
          }

          // checkmate?
          if (game.in_checkmate()) {
            status = "Game over, " + moveColor + " is in checkmate.";

            if (game.turn() === "w") {
              alert("Black won the game !");
            } else {
              alert("White won the game !");
            }
            $.get("/finish", function () {
              window.history.go("/");
            });
          }

          // draw?
          else if (game.in_draw()) {
            status = "Game over, drawn position";
          }

          // game still on
          else {
            status = moveColor + " to move";

            // check?
            if (game.in_check()) {
              status += ", " + moveColor + " is in check";
            }
          }

          $status.html(status);
          $fen.html(game.fen());
          $pgn.html(game.pgn());
        }

        var config = {
          draggable: true,
          position: "start",
          pieceTheme: function (piece) {
            // Return the URL for the new piece image based on the piece code
            return (
              "{{ url_for('static', filename='/chessboardjs/img/chesspieces/wikipedia') }}/" +
              piece +
              ".png"
            );
          },
          onDragStart: onDragStart,
          onDrop: onDrop,
          onSnapEnd: onSnapEnd,
          onMouseoutSquare: onMouseoutSquare,
          onMouseoverSquare: onMouseoverSquare,
        };
        board = Chessboard("myBoard", config);

        updateStatus();
      });
    </script>
  </body>
</html>
